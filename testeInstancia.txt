# üì± Integra√ß√£o Evolution API - Spring Boot

## üìã Vis√£o Geral

Sistema completo de integra√ß√£o com **Evolution API v2.3.6** para gerenciamento de inst√¢ncias WhatsApp em aplica√ß√µes de agendamento (barbearias, sal√µes de beleza, etc).

---

## üöÄ Instala√ß√£o e Configura√ß√£o

### 1. Adicionar Depend√™ncias no `pom.xml`

```xml
<!-- J√° deve estar no projeto -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>

<!-- Para comunica√ß√£o HTTP -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

### 2. Configurar `application.properties`

```properties
# Evolution API Configuration
evolution.api.url=http://localhost:8080
evolution.api.key=SUA_CHAVE_API_AQUI

# Timeout configurations
spring.http.client.connect-timeout=5000
spring.http.client.read-timeout=30000
```

### 3. Executar Migration SQL

Execute o arquivo `V001__create_table_instance.sql` no seu banco de dados:

```bash
# MySQL
mysql -u usuario -p database_name < V001__create_table_instance.sql

# Ou deixe o Flyway/Liquibase executar automaticamente
```

### 4. Adicionar Arquivos ao Projeto

Copie os seguintes arquivos para as respectivas pastas:

```
src/main/java/org/exemplo/bellory/
‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îú‚îÄ‚îÄ entity/whatsapp/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Instance.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InstanceStatus.java
‚îÇ   ‚îú‚îÄ‚îÄ dto/whatsapp/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InstanceDTO.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InstanceCreateDTO.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InstanceUpdateDTO.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WhatsAppMessagingDTOs.java
‚îÇ   ‚îî‚îÄ‚îÄ repository/whatsapp/
‚îÇ       ‚îî‚îÄ‚îÄ InstanceRepository.java
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îî‚îÄ‚îÄ InstanceService.java
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îî‚îÄ‚îÄ InstanceController.java
‚îî‚îÄ‚îÄ config/
    ‚îî‚îÄ‚îÄ RestTemplateConfig.java
```

---

## üì° Endpoints da API

### Base URL
```
http://localhost:8080/api/instances
```

---

### 1Ô∏è‚É£ Criar Nova Inst√¢ncia

**POST** `/api/instances`

Cria uma nova inst√¢ncia do WhatsApp no Evolution API.

**Request Body:**
```json
{
  "instanceName": "barbearia_centro",
  "webhookUrl": "https://seu-dominio.com/webhook",
  "webhookEnabled": true,
  "webhookEvents": [
    "MESSAGES_UPSERT",
    "CONNECTION_UPDATE",
    "QRCODE_UPDATED"
  ],
  "rejectCall": true,
  "msgCall": "Desculpe, n√£o aceitamos liga√ß√µes. Por favor, envie mensagem.",
  "groupsIgnore": true,
  "alwaysOnline": true,
  "readMessages": true,
  "readStatus": false,
  "description": "WhatsApp principal da barbearia"
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "message": "Inst√¢ncia criada com sucesso. Escaneie o QR Code para conectar.",
  "dados": {
    "id": 1,
    "instanceName": "barbearia_centro",
    "qrcode": "data:image/png;base64,iVBORw0KGgo...",
    "status": "DISCONNECTED",
    "phoneNumber": null,
    "profileName": null,
    "webhookUrl": "https://seu-dominio.com/webhook",
    "webhookEnabled": true,
    "webhookEvents": ["MESSAGES_UPSERT", "CONNECTION_UPDATE"],
    "organizacaoId": 1,
    "organizacaoNome": "Barbearia Centro",
    "isActive": true,
    "createdAt": "2024-01-15T10:30:00"
  }
}
```

**Exemplo Java (RestTemplate):**
```java
InstanceCreateDTO dto = new InstanceCreateDTO();
dto.setInstanceName("barbearia_centro");
dto.setRejectCall(true);
dto.setGroupsIgnore(true);

ResponseEntity<ResponseAPI<InstanceDTO>> response = restTemplate.postForEntity(
    "http://localhost:8080/api/instances",
    dto,
    new ParameterizedTypeReference<ResponseAPI<InstanceDTO>>() {}
);

InstanceDTO instance = response.getBody().getDados();
```

---

### 2Ô∏è‚É£ Listar Todas as Inst√¢ncias

**GET** `/api/instances`

Lista todas as inst√¢ncias da organiza√ß√£o atual.

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Inst√¢ncias recuperadas com sucesso.",
  "dados": [
    {
      "id": 1,
      "instanceName": "barbearia_centro",
      "status": "CONNECTED",
      "phoneNumber": "5511999999999",
      "profileName": "Barbearia Centro",
      "organizacaoId": 1,
      "isActive": true
    },
    {
      "id": 2,
      "instanceName": "barbearia_filial",
      "status": "DISCONNECTED",
      "phoneNumber": null,
      "organizacaoId": 1,
      "isActive": true
    }
  ]
}
```

---

### 3Ô∏è‚É£ Buscar Inst√¢ncia por ID

**GET** `/api/instances/{id}`

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Inst√¢ncia encontrada com sucesso.",
  "dados": {
    "id": 1,
    "instanceName": "barbearia_centro",
    "status": "CONNECTED",
    "phoneNumber": "5511999999999",
    "profileName": "Barbearia Centro",
    "profilePictureUrl": "https://...",
    "webhookUrl": "https://seu-dominio.com/webhook",
    "organizacaoId": 1
  }
}
```

---

### 4Ô∏è‚É£ Atualizar Inst√¢ncia

**PUT** `/api/instances/{id}`

**Request Body:**
```json
{
  "webhookUrl": "https://novo-webhook.com/webhook",
  "webhookEnabled": true,
  "rejectCall": false,
  "alwaysOnline": false,
  "description": "Atualizado para novo webhook"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Inst√¢ncia atualizada com sucesso.",
  "dados": { ... }
}
```

---

### 5Ô∏è‚É£ Deletar Inst√¢ncia

**DELETE** `/api/instances/{id}`

Remove a inst√¢ncia do Evolution API e do banco de dados.

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Inst√¢ncia deletada com sucesso."
}
```

---

### 6Ô∏è‚É£ Obter QR Code

**GET** `/api/instances/{id}/qrcode`

Retorna o QR Code em base64 para conectar o WhatsApp.

**Response (200 OK):**
```json
{
  "success": true,
  "message": "QR Code obtido com sucesso. Escaneie para conectar.",
  "dados": {
    "base64": "data:image/png;base64,iVBORw0KGgo...",
    "instanceName": "barbearia_centro"
  }
}
```

**Exemplo de uso no Frontend:**
```html
<img src="data:image/png;base64,iVBORw0KGgo..." alt="QR Code WhatsApp" />
```

---

### 7Ô∏è‚É£ Verificar Status de Conex√£o

**GET** `/api/instances/{id}/status`

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Status da conex√£o obtido com sucesso.",
  "dados": {
    "state": "open",
    "instance": {
      "instanceName": "barbearia_centro",
      "phoneNumber": "5511999999999",
      "profileName": "Barbearia Centro",
      "profilePictureUrl": "https://...",
      "status": "connected"
    }
  }
}
```

**Estados poss√≠veis:**
- `disconnected`: Desconectado
- `connecting`: Conectando
- `open`: Conectado e pronto
- `connected`: Conectado

---

### 8Ô∏è‚É£ Desconectar Inst√¢ncia (Logout)

**POST** `/api/instances/{id}/logout`

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Inst√¢ncia desconectada com sucesso."
}
```

---

### 9Ô∏è‚É£ Reiniciar Inst√¢ncia

**POST** `/api/instances/{id}/restart`

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Inst√¢ncia reiniciada com sucesso."
}
```

---

### üîü Enviar Mensagem de Texto

**POST** `/api/instances/{id}/send-text`

**Request Body:**
```json
{
  "number": "5511999999999",
  "text": "Ol√°! Seu agendamento foi confirmado para amanh√£ √†s 14h. üòä"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Mensagem enviada com sucesso.",
  "dados": {
    "key": {
      "remoteJid": "5511999999999@s.whatsapp.net",
      "fromMe": true,
      "id": "BAE5F3..."
    },
    "message": {
      "conversation": "Ol√°! Seu agendamento foi confirmado..."
    },
    "messageTimestamp": "1705326000"
  }
}
```

---

## üéØ Casos de Uso Pr√°ticos

### 1. Confirma√ß√£o de Agendamento

```java
@Service
public class AgendamentoNotificationService {

    @Autowired
    private InstanceService instanceService;

    @Autowired
    private InstanceRepository instanceRepository;

    public void enviarConfirmacaoAgendamento(Agendamento agendamento) {
        // Buscar inst√¢ncia ativa da organiza√ß√£o
        List<Instance> instances = instanceRepository
            .findByOrganizacaoIdAndStatusIn(
                agendamento.getOrganizacao().getId(),
                Arrays.asList(InstanceStatus.OPEN, InstanceStatus.CONNECTED)
            );

        if (instances.isEmpty()) {
            log.warn("Nenhuma inst√¢ncia conectada para enviar mensagem");
            return;
        }

        Instance instance = instances.get(0);

        // Montar mensagem
        String mensagem = String.format(
            """
            Ol√° %s! üëã

            Seu agendamento foi confirmado! ‚úÖ

            üìÖ Data: %s
            ‚è∞ Hor√°rio: %s
            üíà Servi√ßo: %s
            üë®‚Äçü¶≤ Profissional: %s

            Endere√ßo: %s

            Chegue com 10 minutos de anteced√™ncia.

            At√© l√°! üòä
            """,
            agendamento.getCliente().getNome(),
            agendamento.getDtAgendamento().format(DateTimeFormatter.ofPattern("dd/MM/yyyy")),
            agendamento.getDtAgendamento().format(DateTimeFormatter.ofPattern("HH:mm")),
            agendamento.getServicos().stream()
                .map(Servico::getNome)
                .collect(Collectors.joining(", ")),
            agendamento.getFuncionarios().get(0).getNome(),
            agendamento.getOrganizacao().getEndereco()
        );

        // Enviar mensagem
        SendTextMessageDTO dto = new SendTextMessageDTO();
        dto.setNumber(agendamento.getCliente().getTelefone());
        dto.setText(mensagem);

        try {
            instanceService.sendTextMessage(instance.getId(), dto);
            log.info("Confirma√ß√£o enviada para: {}", agendamento.getCliente().getTelefone());
        } catch (Exception e) {
            log.error("Erro ao enviar confirma√ß√£o: {}", e.getMessage());
        }
    }
}
```

### 2. Lembrete Autom√°tico (1 dia antes)

```java
@Service
public class LembreteAgendamentoService {

    @Scheduled(cron = "0 0 9 * * *") // Todos os dias √†s 9h
    public void enviarLembretes() {
        LocalDate amanha = LocalDate.now().plusDays(1);
        LocalDateTime inicioDia = amanha.atStartOfDay();
        LocalDateTime fimDia = amanha.atTime(23, 59, 59);

        List<Agendamento> agendamentos = agendamentoRepository
            .findByDtAgendamentoBetween(inicioDia, fimDia);

        for (Agendamento agendamento : agendamentos) {
            enviarLembrete(agendamento);
        }
    }

    private void enviarLembrete(Agendamento agendamento) {
        String mensagem = String.format(
            """
            üîî LEMBRETE

            Ol√° %s!

            Voc√™ tem agendamento AMANH√É:
            üìÖ %s √†s %s
            üíà %s

            Nos vemos em breve! ‚ú®
            """,
            agendamento.getCliente().getNome(),
            agendamento.getDtAgendamento().format(DateTimeFormatter.ofPattern("dd/MM/yyyy")),
            agendamento.getDtAgendamento().format(DateTimeFormatter.ofPattern("HH:mm")),
            agendamento.getServicos().stream()
                .map(Servico::getNome)
                .collect(Collectors.joining(", "))
        );

        // L√≥gica para enviar mensagem...
    }
}
```

### 3. Envio de Promo√ß√µes em Massa

```java
@Service
public class PromocaoService {

    public void enviarPromocaoParaClientes(Long organizacaoId, String mensagem) {
        // Buscar inst√¢ncia conectada
        List<Instance> instances = instanceRepository
            .findByOrganizacaoIdAndStatusIn(
                organizacaoId,
                Arrays.asList(InstanceStatus.OPEN, InstanceStatus.CONNECTED)
            );

        if (instances.isEmpty()) {
            throw new IllegalStateException("Nenhuma inst√¢ncia conectada");
        }

        Instance instance = instances.get(0);

        // Buscar clientes da organiza√ß√£o
        List<Cliente> clientes = clienteRepository
            .findByOrganizacaoIdAndIsActive(organizacaoId, true);

        for (Cliente cliente : clientes) {
            try {
                SendTextMessageDTO dto = new SendTextMessageDTO();
                dto.setNumber(cliente.getTelefone());
                dto.setText(mensagem);

                instanceService.sendTextMessage(instance.getId(), dto);

                // Aguardar 2 segundos entre envios (evitar bloqueio)
                Thread.sleep(2000);

            } catch (Exception e) {
                log.error("Erro ao enviar para {}: {}",
                    cliente.getTelefone(), e.getMessage());
            }
        }
    }
}
```

### 4. Fluxo Completo de Conex√£o

```java
@Service
public class WhatsAppConnectionService {

    public InstanceDTO conectarNovaInstancia(String instanceName) {
        // 1. Criar inst√¢ncia
        InstanceCreateDTO createDto = new InstanceCreateDTO();
        createDto.setInstanceName(instanceName);
        createDto.setRejectCall(true);
        createDto.setGroupsIgnore(true);
        createDto.setAlwaysOnline(true);

        InstanceDTO instance = instanceService.createInstance(createDto);
        log.info("Inst√¢ncia criada: {}", instance.getId());

        // 2. O QR Code j√° vem na cria√ß√£o
        String qrcode = instance.getQrcode();
        // Exibir QR Code para o usu√°rio escanear

        // 3. Verificar status periodicamente
        boolean conectado = false;
        int tentativas = 0;
        int maxTentativas = 60; // 5 minutos (verificando a cada 5 segundos)

        while (!conectado && tentativas < maxTentativas) {
            try {
                Thread.sleep(5000); // Aguardar 5 segundos

                Map<String, Object> status = instanceService
                    .getConnectionStatus(instance.getId());

                String state = (String) status.get("state");

                if ("open".equals(state) || "connected".equals(state)) {
                    conectado = true;
                    log.info("WhatsApp conectado com sucesso!");

                    // Obter dados do perfil
                    Map<String, Object> instanceInfo =
                        (Map<String, Object>) status.get("instance");

                    String phoneNumber = (String) instanceInfo.get("phoneNumber");
                    String profileName = (String) instanceInfo.get("profileName");

                    log.info("N√∫mero: {}, Nome: {}", phoneNumber, profileName);
                }

                tentativas++;

            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }

        if (!conectado) {
            log.warn("Timeout: WhatsApp n√£o foi conectado dentro do tempo limite");
        }

        return instanceService.getInstanceById(instance.getId());
    }
}
```

---

## ‚öôÔ∏è Configura√ß√µes Avan√ßadas

### Eventos de Webhook Dispon√≠veis

```java
public enum WebhookEvent {
    MESSAGES_UPSERT,        // Nova mensagem recebida
    MESSAGES_UPDATE,        // Mensagem atualizada (lida, entregue)
    CONNECTION_UPDATE,      // Status de conex√£o alterado
    QRCODE_UPDATED,        // QR Code foi atualizado
    CALL,                  // Chamada recebida
    GROUPS_UPSERT,         // Grupo criado/atualizado
    GROUPS_UPDATE,         // Informa√ß√µes do grupo atualizadas
    GROUP_PARTICIPANTS_UPDATE, // Participantes do grupo atualizados
    PRESENCE_UPDATE,       // Status de presen√ßa (online/offline)
    CHATS_UPDATE,          // Chat atualizado
    CHATS_UPSERT,          // Novo chat
    CHATS_DELETE,          // Chat deletado
    CONTACTS_UPDATE,       // Contato atualizado
    CONTACTS_UPSERT        // Novo contato
}
```

### Receber Webhooks

```java
@RestController
@RequestMapping("/api/webhook")
public class WebhookController {

    @PostMapping
    public ResponseEntity<Void> receberWebhook(@RequestBody Map<String, Object> payload) {
        String event = (String) payload.get("event");
        String instanceName = (String) payload.get("instance");

        log.info("Webhook recebido - Evento: {}, Inst√¢ncia: {}", event, instanceName);

        switch (event) {
            case "MESSAGES_UPSERT":
                processarNovaMensagem(payload);
                break;

            case "CONNECTION_UPDATE":
                processarMudancaConexao(payload);
                break;

            case "QRCODE_UPDATED":
                processarQRCodeAtualizado(payload);
                break;

            default:
                log.debug("Evento n√£o tratado: {}", event);
        }

        return ResponseEntity.ok().build();
    }

    private void processarNovaMensagem(Map<String, Object> payload) {
        Map<String, Object> data = (Map<String, Object>) payload.get("data");
        List<Map<String, Object>> messages = (List<Map<String, Object>>) data.get("messages");

        for (Map<String, Object> message : messages) {
            Map<String, Object> key = (Map<String, Object>) message.get("key");
            String from = (String) key.get("remoteJid");
            boolean fromMe = (Boolean) key.get("fromMe");

            if (!fromMe) { // Apenas mensagens recebidas
                Map<String, Object> messageContent = (Map<String, Object>) message.get("message");
                String text = (String) messageContent.get("conversation");

                log.info("Mensagem de {}: {}", from, text);

                // Aqui voc√™ pode implementar l√≥gica de resposta autom√°tica
                // Por exemplo, responder com menu de op√ß√µes
            }
        }
    }

    private void processarMudancaConexao(Map<String, Object> payload) {
        Map<String, Object> data = (Map<String, Object>) payload.get("data");
        String state = (String) data.get("state");

        log.info("Status de conex√£o mudou para: {}", state);

        // Atualizar no banco de dados se necess√°rio
    }

    private void processarQRCodeAtualizado(Map<String, Object> payload) {
        Map<String, Object> data = (Map<String, Object>) payload.get("data");
        String qrcode = (String) data.get("qrcode");

        log.info("QR Code atualizado");

        // Notificar o usu√°rio para escanear o novo QR Code
    }
}
```

---

## üîí Seguran√ßa

### Valida√ß√£o Multi-Tenant

O sistema j√° implementa valida√ß√£o autom√°tica de organiza√ß√£o:

```java
// Toda requisi√ß√£o valida se o recurso pertence √† organiza√ß√£o do usu√°rio
private void validarOrganizacao(Long entityOrganizacaoId) {
    Long organizacaoId = TenantContext.getCurrentOrganizacaoId();

    if (!organizacaoId.equals(entityOrganizacaoId)) {
        throw new SecurityException("Acesso negado");
    }
}
```

---

## ‚ö†Ô∏è Observa√ß√µes Importantes

1. **Rate Limiting**: Aguarde 2-3 segundos entre envios de mensagens para evitar bloqueio do WhatsApp
2. **Formato de N√∫mero**: Use sempre formato internacional: `5511999999999` (c√≥digo pa√≠s + DDD + n√∫mero)
3. **Backup**: Mantenha backup das inst√¢ncias no banco de dados
4. **Webhooks**: Configure uma URL p√∫blica acess√≠vel para receber eventos
5. **Seguran√ßa**: Nunca exponha credenciais da Evolution API

---

## üêõ Troubleshooting

### Inst√¢ncia n√£o conecta
- Verifique se o QR Code est√° sendo exibido
- Confirme se est√° usando o mesmo telefone
- Tente reiniciar: `POST /api/instances/{id}/restart`

### Mensagens n√£o s√£o enviadas
- Verifique se a inst√¢ncia est√° com status "CONNECTED" ou "OPEN"
- Confirme o formato do n√∫mero (5511999999999)
- Verifique logs do Evolution API

### Webhook n√£o recebe eventos
- Confirme se a URL est√° acess√≠vel publicamente
- Teste com ferramentas como webhook.site
- Verifique os eventos configurados

---

## üìö Recursos Adicionais

- [Documenta√ß√£o Evolution API](https://doc.evolution-api.com/)
- [WhatsApp Business Policy](https://www.whatsapp.com/legal/business-policy)
- [Spring Boot Documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/)
